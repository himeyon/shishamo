<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="red.sukun1899.repository.TableRepository">
    <resultMap id="tableMap" type="red.sukun1899.model.Table" autoMapping="true">
        <id property="name" column="name"/>
        <collection property="columns" ofType="red.sukun1899.model.Column" autoMapping="true" columnPrefix="column_">
            <id column="name" property="name"/>
            <association property="parentColumn" javaType="red.sukun1899.model.ReferencedColumn" autoMapping="true"
                         columnPrefix="parent_"/>
            <collection property="childColumns" ofType="red.sukun1899.model.ReferencedColumn" autoMapping="true"
                        columnPrefix="child_">
                <id column="tableName" property="tableName"/>
            </collection>
        </collection>
    </resultMap>

    <!--suppress SqlDialectInspection -->
    <select id="selectAll" resultMap="tableMap">
        SELECT
            tab.table_name AS `name`
          , tab.table_comment AS `comment`
        FROM
          information_schema.tables tab
        WHERE
          tab.table_schema = #{schemaName}
    </select>

    <!--suppress SqlDialectInspection -->
    <select id="select" resultMap="tableMap">
        SELECT
            tab.table_name AS `name`
          , tab.table_comment AS `comment`
          , col.column_name as `column_name`
          , col.column_type as `column_type`
          , col.column_default as `column_defaultValue`
          , col.is_nullable as `column_nullable`
          , col.column_comment as `column_comment`
          , parent.referenced_table_name as `column_parent_tableName`
          , child.column_name as `column_child_name`
          , child.table_name as `column_child_tableName`
        FROM
          information_schema.tables tab
          INNER JOIN
          information_schema.columns col
            ON tab.table_schema = col.table_schema AND tab.table_name = col.table_name
          LEFT OUTER JOIN
          information_schema.key_column_usage parent
            ON col.table_schema = parent.table_schema
                AND col.table_name = parent.table_name
                AND col.column_name = parent.column_name
          LEFT OUTER JOIN
          information_schema.key_column_usage child
            ON col.table_schema = child.table_schema
                AND col.table_name = child.referenced_table_name
                AND col.column_name = child.referenced_column_name
        WHERE
          tab.table_schema = #{schemaName}
          AND
          tab.table_name = #{name}
        ORDER BY
          col.ordinal_position
    </select>
</mapper>